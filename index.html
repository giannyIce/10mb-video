<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mac MOV to 10MB MP4</title>
    <script src="https://unpkg.com/mp4box@0.5.2/dist/mp4box.all.min.js"></script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        display: grid;
        place-items: center;
        height: 100vh;
        background: #f5f5f7;
        color: #1d1d1f;
      }
      .container {
        background: white;
        padding: 40px;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        text-align: center;
        width: 400px;
      }
      .drop-zone {
        border: 2px dashed #86868b;
        border-radius: 12px;
        padding: 40px 20px;
        margin: 20px 0;
        transition: 0.2s;
        cursor: pointer;
      }
      .drop-zone:hover {
        border-color: #0071e3;
        background: #fbfbfd;
      }
      h1 {
        font-size: 24px;
        margin-bottom: 10px;
      }
      button {
        background: #0071e3;
        color: white;
        border: none;
        padding: 12px 24px;
        font-size: 16px;
        border-radius: 99px;
        cursor: pointer;
        display: none;
        margin: 0 auto;
      }
      .bar-bg {
        background: #e5e5e5;
        height: 6px;
        border-radius: 3px;
        overflow: hidden;
        margin-top: 15px;
        display: none;
      }
      .bar-fill {
        background: #0071e3;
        height: 100%;
        width: 0%;
        transition: width 0.1s linear;
      }
      .stats {
        font-size: 12px;
        color: #86868b;
        margin-top: 10px;
        height: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Screen Recording Shrinker</h1>
      <p style="color: #86868b; font-size: 14px">Drag your Mac .mov here</p>

      <div class="drop-zone" id="dropArea">Drop .mov file here</div>

      <div class="bar-bg" id="progressBar">
        <div class="bar-fill" id="progressFill"></div>
      </div>
      <div class="stats" id="statusText">Target: < 10MB • Time: < 5s</div>

      <button id="dlBtn">Download MP4</button>
    </div>

    <script>
      const dropArea = document.getElementById("dropArea");
      const statusText = document.getElementById("statusText");
      const progressBar = document.getElementById("progressBar");
      const progressFill = document.getElementById("progressFill");
      const dlBtn = document.getElementById("dlBtn");

      // UI Handlers
      dropArea.ondragover = (e) => {
        e.preventDefault();
        dropArea.style.borderColor = "#0071e3";
      };
      dropArea.ondragleave = () => {
        dropArea.style.borderColor = "#86868b";
      };
      dropArea.ondrop = (e) => {
        e.preventDefault();
        handleFile(e.dataTransfer.files[0]);
      };
      dropArea.onclick = () => {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = "video/*";
        input.onchange = (e) => handleFile(e.target.files[0]);
        input.click();
      };

      async function handleFile(file) {
        if (!file) return;

        // Reset UI
        dlBtn.style.display = "none";
        progressBar.style.display = "block";
        statusText.innerText = "Initializing Hardware Encoder...";

        // 1. Prepare Video Element (The Decoder)
        const video = document.createElement("video");
        video.muted = true;
        video.src = URL.createObjectURL(file);
        await video.play(); // Required to get dimensions

        const duration = video.duration;
        const srcWidth = video.videoWidth;
        const srcHeight = video.videoHeight;

        // 2. Calculate "Safe" Bitrate (Max 9.5MB file size)
        // Formula: (9.5MB * 8 bits) / duration_seconds
        const targetSize = 9.5 * 1024 * 1024;
        let bitrate = Math.floor((targetSize * 8) / duration);
        // Cap bitrate: Min 500kbps (quality floor), Max 4Mbps (speed ceiling)
        bitrate = Math.max(500000, Math.min(bitrate, 4000000));

        // 3. Retina Downscale Logic (CRITICAL FOR SPEED)
        // Mac screens are huge. We scale to 720p height max to ensure < 5s processing.
        let targetHeight = 720;
        if (srcHeight < 720) targetHeight = srcHeight;
        // Keep aspect ratio
        let targetWidth = Math.round((srcWidth / srcHeight) * targetHeight);
        // Ensure even numbers (required by H.264)
        targetWidth = targetWidth + (targetWidth % 2);
        targetHeight = targetHeight + (targetHeight % 2);

        statusText.innerText = `Converting: ${srcWidth}x${srcHeight} → ${targetWidth}x${targetHeight}`;

        // 4. Set up Canvas & Encoder
        const canvas = document.createElement("canvas");
        canvas.width = targetWidth;
        canvas.height = targetHeight;
        const ctx = canvas.getContext("2d", {
          desynchronized: true,
          alpha: false,
        });

        const mp4File = MP4Box.createFile();
        let trackId = null;

        const encoder = new VideoEncoder({
          output: (chunk, meta) => {
            if (trackId === null) {
              trackId = mp4File.addTrack({
                timescale: 1000000,
                width: targetWidth,
                height: targetHeight,
                avcDecoderConfigRecord: meta.decoderConfig.description,
              });
            }
            const buf = new ArrayBuffer(chunk.byteLength);
            chunk.copyTo(buf);
            mp4File.addSample(trackId, buf, {
              duration: chunk.duration ?? 0,
              dts: chunk.timestamp,
              cts: chunk.timestamp,
              is_sync: chunk.type === "key",
            });
          },
          error: (e) => console.error("Encoder Error", e),
        });

        encoder.configure({
          codec: "avc1.42001E", // H.264 Constrained Baseline (Fastest)
          width: targetWidth,
          height: targetHeight,
          bitrate: bitrate,
          framerate: 30,
          hardwareAcceleration: "prefer-hardware",
          latencyMode: "realtime",
        });

        // 5. The "Fast Forward" Loop
        const startTime = performance.now();
        const fps = 30;
        const interval = 1.0 / fps;
        let currentTime = 0;
        let frameCount = 0;

        // "Seek" method is faster than "Play" for downscaling huge jumps
        // We manually step through the video file.
        while (currentTime < duration) {
          video.currentTime = currentTime;

          // Wait for seek to finish
          await new Promise((r) => {
            const onSeek = () => {
              video.removeEventListener("seeked", onSeek);
              r();
            };
            video.addEventListener("seeked", onSeek);
          });

          // Draw & Encode
          ctx.drawImage(video, 0, 0, targetWidth, targetHeight);

          const frame = new VideoFrame(canvas, {
            timestamp: currentTime * 1000000,
            duration: interval * 1000000,
          });

          // Keyframe every 2 seconds (60 frames)
          encoder.encode(frame, { keyFrame: frameCount % 60 === 0 });
          frame.close();

          // Progress Bar
          const percent = (currentTime / duration) * 100;
          progressFill.style.width = `${percent}%`;

          // Step forward
          currentTime += interval;
          frameCount++;

          // Emergency Bailout: If we exceed 5 seconds of REAL time, stop?
          // Optional: Uncomment below to force stop at 5s mark regardless of completion
          // if (performance.now() - startTime > 5000) break;
        }

        await encoder.flush();

        // Finalize
        const blob = new Blob([mp4File.getBuffer()], { type: "video/mp4" });
        const finalTime = ((performance.now() - startTime) / 1000).toFixed(1);

        statusText.innerText = `✅ Done in ${finalTime}s • Size: ${(blob.size / 1024 / 1024).toFixed(2)} MB`;
        dlBtn.style.display = "block";
        dlBtn.innerText = "Download MP4";
        dlBtn.onclick = () => {
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = `converted_${Date.now()}.mp4`;
          a.click();
        };
      }
    </script>
  </body>
</html>
